=========================
# FILE: main.py
=========================
from flask import Flask, render_template, request, redirect, url_for, jsonify
import os
import json
import datetime
import uuid
from collections import Counter
from typing import Optional, Iterable, List, Tuple
from typing import Optional
from markupsafe import Markup, escape
from admin import admin_bp

app = Flask(__name__, 
template_folder="templates", 
static_folder="static")
app.register_blueprint(admin_bp, url_prefix="/admin")
DATA_FILE = "data.json"
HOUR_FILE = "hour.json"


BOXES = {
    "cowboy_win": ("ü§† Cowboy", "x2", "default"),
    "draw": ("H√≤a", "x20", "orange"),
    "bull_win": ("üêÆ Bull", "x2", "default"),

    "suited_combo": ("D√¢y / ƒê·ªìng ch·∫•t / D√¢y ƒë·ªìng ch·∫•t", "x1.66", "default"),
    "pair_any": ("ƒê√¥i", "x8.5", "default"),
    "aa": ("AA", "x100", "default"),

    "high_onepair": ("B√†i cao / M·ªôt ƒë√¥i", "x2.2", "default"),
    "two_pair": ("Hai ƒë√¥i", "x3.1", "default"),
    "trips": ("B·ªô ba", "x4.7", "default"),
    "full_house": ("C√π l≈©", "x20", "orange"),
    "four_kind": ("T·ª© qu√Ω", "x248", "red"),
}

RANKS = "23456789TJQKA"
SUITS = ['h', 'd', 'c', 's']

# -----------------------
# Data helpers
# -----------------------
def all_cards() -> List[str]:
    return [r + s for r in RANKS for s in SUITS]

def card_label(c: Optional[str]) -> Optional[str]:
    if not c or len(c) < 2:
        return c
    rank = c[0].upper()
    suit = c[1].lower()
    if rank == "T":
        rank = "10"
    map_s = {'s': '‚ô†', 'h': '‚ô•', 'd': '‚ô¶', 'c': '‚ô£'}
    symbol = map_s.get(suit, suit)

    # M√†u c·ªë ƒë·ªãnh
    red = '#c92a2a'        # hearts & diamonds
    dark = '#222222'       # spades & clubs

    if suit in ('h', 'd'):
        # tr·∫£ v·ªÅ HTML v·ªõi style inline m√†u ƒë·ªè
        return Markup(f'{escape(rank)}<span style="color:{red};font-weight:600;margin-left:4px">{escape(symbol)}</span>')
    else:
        return Markup(f'{escape(rank)}<span style="color:{dark};font-weight:600;margin-left:4px">{escape(symbol)}</span>')

def ensure_data_file() -> None:
    if not os.path.exists(DATA_FILE):
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump([], f)

def load_data() -> List[dict]:
    ensure_data_file()
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except (json.JSONDecodeError, OSError):
        return []

def save_data(arr: List[dict]) -> None:
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(arr, f, ensure_ascii=False, indent=2)

# -----------------------
# Hour file helpers (slot -> list of cards)
# -----------------------
def ensure_hour_file() -> None:
    if not os.path.exists(HOUR_FILE):
        with open(HOUR_FILE, "w", encoding="utf-8") as f:
            json.dump({"aa": {}, "four_kind": {}}, f)

def load_hour_data() -> dict:
    ensure_hour_file()
    try:
        with open(HOUR_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
    except (json.JSONDecodeError, OSError):
        data = {"aa": {}, "four_kind": {}}

    # migrate nh·∫π n·∫øu d·ªØ li·ªáu c≈© l√† list c√°c HH:MM strings
    for key in ("aa", "four_kind"):
        if key in data and isinstance(data[key], list):
            new = {}
            for t in data[key]:
                if isinstance(t, str):
                    new.setdefault(t, [])
            data[key] = new
        elif key not in data:
            data[key] = {}

    return data

def save_hour_data(data: dict) -> None:
    with open(HOUR_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# -----------------------
# Time helpers (VN)
# -----------------------
VN_TZ = datetime.timezone(datetime.timedelta(hours=7))

def now_vn() -> datetime.datetime:
    return datetime.datetime.now(datetime.timezone.utc).astimezone(VN_TZ)

def format_hhmm(dt: datetime.datetime) -> str:
    return dt.strftime("%H:%M")

def parse_hhmm(s: str) -> Optional[Tuple[int, int]]:
    """
    Chuy·ªÉn 'HH:MM' -> (h, m). Tr·∫£ None n·∫øu kh√¥ng ph·∫£i chu·ªói h·ª£p l·ªá ho·∫∑c ngo√†i ph·∫°m vi.
    """
    if not isinstance(s, str):
        return None
    parts = s.split(":")
    if len(parts) != 2:
        return None
    try:
        h = int(parts[0])
        m = int(parts[1])
    except ValueError:
        return None
    if 0 <= h < 24 and 0 <= m < 60:
        return h, m
    return None

def hhmm_to_minutes(hhmm: str) -> Optional[int]:
    """
    Chuy·ªÉn 'HH:MM' -> s·ªë ph√∫t t·ª´ 00:00, ho·∫∑c None n·∫øu input kh√¥ng h·ª£p l·ªá.
    """
    parsed = parse_hhmm(hhmm)
    if parsed is None:
        return None
    h, m = parsed
    return h * 60 + m

def minutes_to_hhmm(minutes: int) -> str:
    minutes = minutes % (24 * 60)
    h = minutes // 60
    m = minutes % 60
    return f"{h:02d}:{m:02d}"

def next_cycle_slots(history_list: Optional[Iterable[str]], n: int = 3) -> Optional[List[str]]:
    """
    Tr·∫£ v·ªÅ danh s√°ch n slot 'HH:MM' ti·∫øp theo theo v√≤ng trong ng√†y d·ª±a tr√™n history_list.
    - history_list c√≥ th·ªÉ l√† None, list c√°c chu·ªói, ho·∫∑c dict.keys() (iterable).
    - N·∫øu kh√¥ng c√≥ slot h·ª£p l·ªá tr·∫£ v·ªÅ None.
    - S·∫Øp x·∫øp theo ph√∫t trong ng√†y, ch·ªçn slot ƒë·∫ßu ti√™n l·ªõn h∆°n th·ªùi ƒëi·ªÉm hi·ªán t·∫°i,
      n·∫øu kh√¥ng c√≥ th√¨ quay v√≤ng t·ª´ ƒë·∫ßu.
    """
    if not history_list:
        return None

    # Chu·∫©n ho√°: l·∫•y c√°c chu·ªói h·ª£p l·ªá 'HH:MM' duy nh·∫•t theo th·ª© t·ª± xu·∫•t hi·ªán
    seen = set()
    clean: List[str] = []
    for item in history_list:
        if not isinstance(item, str):
            continue
        if item in seen:
            continue
        if parse_hhmm(item) is None:
            continue
        seen.add(item)
        clean.append(item)

    if not clean:
        return None

    # helper chuy·ªÉn 'HH:MM' -> ph√∫t (ƒë·∫£m b·∫£o int)
    def to_minutes(s: str) -> int:
        val = hhmm_to_minutes(s)
        return int(val) if val is not None else 0

    sorted_day = sorted(clean, key=to_minutes)

    now_minutes = now_vn().hour * 60 + now_vn().minute

    # t√¨m index b·∫Øt ƒë·∫ßu: slot ƒë·∫ßu ti√™n c√≥ ph√∫t > now_minutes
    idx_start = 0
    for i, s in enumerate(sorted_day):
        if to_minutes(s) > now_minutes:
            idx_start = i
            break
    else:
        idx_start = 0

    length = len(sorted_day)
    res = [sorted_day[(idx_start + k) % length] for k in range(n)]
    return res

# -----------------------
# Statistics
# -----------------------
def compute_stats_for_card(card: str) -> dict:
    data = load_data()  # list round objects (schema m·ªõi)
    # l·ªçc rounds cho l√° ƒë∆∞·ª£c ch·ªçn
    rounds = [r for r in data if r.get("first_card") == card]
    total = len(rounds)

    # counts: s·ªë rounds ch·ª©a m·ªói box (inclusive)
    counts = Counter()
    for r in rounds:
        sbs = r.get("selected_boxes") or []
        for sb in sbs:
            counts[sb] += 1

    # percent: t·ªâ l·ªá m·ªói √¥ tr√™n t·ªïng rounds (inclusive)
    percent = {k: round((counts.get(k, 0) / total * 100), 2) if total > 0 else 0.0 for k in BOXES.keys()}

    SECTIONS = {
        "top": ["cowboy_win", "draw", "bull_win"],
        "left_group": ["pair_any", "aa"],
        "right": ["high_onepair", "two_pair", "trips", "full_house", "four_kind"]
    }

    percent_by_section = {}

    # top: n·ªôi b·ªô trong section (gi·ªØ nh∆∞ tr∆∞·ªõc)
    top_keys = SECTIONS["top"]
    top_total = sum(counts.get(k, 0) for k in top_keys)
    for k in top_keys:
        percent_by_section[k] = round((counts.get(k, 0) / top_total * 100), 2) if top_total > 0 else 0.0

    # left_group v√† suited_combo: t√≠nh theo t·ªïng rounds (inclusive)
    for k in SECTIONS["left_group"]:
        percent_by_section[k] = percent.get(k, 0.0)
    percent_by_section["suited_combo"] = percent.get("suited_combo", 0.0)

    # right: non-four normalized n·ªôi b·ªô; four_kind ƒë·ªôc l·∫≠p theo t·ªïng rounds
    right_non_four = ["high_onepair", "two_pair", "trips", "full_house"]
    non_four_total = sum(counts.get(k, 0) for k in right_non_four)
    for k in right_non_four:
        percent_by_section[k] = round((counts.get(k, 0) / non_four_total * 100), 2) if non_four_total > 0 else 0.0
    percent_by_section["four_kind"] = round((counts.get("four_kind", 0) / total * 100), 2) if total > 0 else 0.0

    return {
        "total": total,
        "counts": dict(counts),
        "percent": percent,
        "percent_by_section": percent_by_section
    }
    
def compute_global_top_cards(limit: int = 12) -> List[tuple]:
    data = load_data()  # m·ªói ph·∫ßn t·ª≠ l√† 1 round
    c = Counter()
    for r in data:
        card = r.get("first_card")
        if card:
            c[card] += 1
    return c.most_common(limit)
    
# -----------------------
# Helpers for hour.json analysis
# -----------------------
def best_card_for_slot_from_hour(hour_box: dict, slot: str, min_samples: int = 1) -> Optional[dict]:
    if not isinstance(hour_box, dict):
        return None
    cards = hour_box.get(slot, [])
    if not cards:
        return None
    counts = Counter(cards)
    total = len(cards)
    best_card, best_count = counts.most_common(1)[0]
    if best_count < min_samples:
        return None
    return {
        "card": best_card,
        "count": best_count,
        "total": total,
        "rate": round(best_count / total * 100, 2)
    }

def compute_topN_for_box(hour_data: dict, box_key: str, limit: int = 5) -> List[dict]:
    """
    T√≠nh top N l√° b√†i cho m·ªôt box (v√≠ d·ª• 'aa' ho·∫∑c 'four_kind').
    Tr·∫£ v·ªÅ list c√°c dict: {card, count, total, rate}
    """
    counts = Counter()
    total = 0
    box_dict = hour_data.get(box_key, {})
    if not isinstance(box_dict, dict):
        return []
    for slot, cards in box_dict.items():
        if isinstance(cards, list):
            for c in cards:
                counts[c] += 1
                total += 1
    top = counts.most_common(limit)
    result = []
    for card, cnt in top:
        result.append({
            "card": card,
            "count": cnt,
            "total": total,
            "rate": round((cnt / total * 100) if total > 0 else 0.0, 2)
        })
    return result

# -----------------------
# Minute stats helper + API
# -----------------------
from flask import request  # n·∫øu ch∆∞a import ·ªü ƒë·∫ßu file

def minute_counts_for_box(hour_data: dict, box_key: str) -> list:
    """
    Tr·∫£ v·ªÅ list 1440 s·ªë nguy√™n: counts[0] = s·ªë l·∫ßn n·ªï ph√∫t 00:00,
    counts[1] = ph√∫t 00:01, ..., counts[1439] = ph√∫t 23:59.
    """
    counts = [0] * (24 * 60)
    box = hour_data.get(box_key, {}) if isinstance(hour_data, dict) else {}
    for slot, cards in box.items():
        parsed = parse_hhmm(slot)
        if parsed is None:
            continue
        h, m = parsed
        idx = h * 60 + m
        if isinstance(cards, list):
            counts[idx] += len(cards)
        elif isinstance(cards, int):
            counts[idx] += cards
    return counts

# -----------------------
# Routes
# -----------------------
@app.route("/api/four_kind_minutes")
def api_four_kind_minutes():
    """
    Tr·∫£ v·ªÅ d·ªØ li·ªáu theo ph√∫t. H·ªó tr·ª£ query param ?agg=N ƒë·ªÉ gom N ph√∫t.
    N·∫øu agg=1 tr·∫£ 1440 ƒëi·ªÉm; n·∫øu agg>1 tr·∫£ buckets (labels l√† start time c·ªßa bucket).
    """
    try:
        agg = int(request.args.get('agg', '1'))
        if agg <= 0:
            agg = 1
    except Exception:
        agg = 1

    hour_data = load_hour_data()
    counts = minute_counts_for_box(hour_data, "four_kind")

    if agg == 1:
        labels = [f"{h:02d}:{m:02d}" for h in range(24) for m in range(60)]
        return jsonify({"labels": labels, "counts": counts})
    else:
        buckets = []
        labels = []
        for start in range(0, 24*60, agg):
            s = sum(counts[start:start+agg])
            buckets.append(s)
            h = start // 60
            m = start % 60
            labels.append(f"{h:02d}:{m:02d}")
        return jsonify({"labels": labels, "counts": buckets, "agg": agg})

@app.route("/", methods=["GET"])
def index():
    sel = request.args.get("card", "")
    cards = all_cards()
    top_cards = compute_global_top_cards()
    details = compute_stats_for_card(sel) if sel else None

    # aggregate across rounds (schema m·ªõi)
    data = load_data()
    agg_counts = Counter()
    total_all = len(data)  # m·ªói ph·∫ßn t·ª≠ l√† 1 round
    for r in data:
        sbs = r.get("selected_boxes", []) or []
        for sb in sbs:
            agg_counts[sb] += 1
    agg_percent = {k: round((agg_counts.get(k, 0) / total_all * 100) if total_all > 0 else 0.0, 2) for k in BOXES.keys()}

    # load hour data early
    hour_data = load_hour_data()

    # L·∫•y danh s√°ch slot t·ª´ hour_data (keys c·ªßa dict)
    aa_box = hour_data.get("aa", {})
    fk_box = hour_data.get("four_kind", {})

    aa_slots = list(aa_box.keys()) if isinstance(aa_box, dict) else []
    fk_slots = list(fk_box.keys()) if isinstance(fk_box, dict) else []

    aa_recent = aa_slots[-3:][::-1] if aa_slots else []
    fk_recent = fk_slots[-3:][::-1] if fk_slots else []

    # predictions (theo v√≤ng l·∫∑p trong ng√†y) d·ª±a tr√™n slot list
    aa_pred = next_cycle_slots(aa_slots, 3)
    fk_pred = next_cycle_slots(fk_slots, 3)

    # t·ªïng s·ªë b·∫£n ghi trong data (d√πng khi ch∆∞a ch·ªçn l√°)
    total_all = len(data)

    # n·∫øu c√≥ l√° ƒë∆∞·ª£c ch·ªçn, details ƒë√£ ch·ª©a "total"
    if sel and details:
        count_for_display = details.get("total", 0)
    else:
        count_for_display = total_all

    # T√≠nh l√° t·ªët nh·∫•t cho m·ªói slot (d·ª±a tr√™n hour.json)
    aa_best: dict = {}
    fk_best: dict = {}
    for t in aa_recent:
        aa_best[t] = best_card_for_slot_from_hour(hour_data.get("aa", {}), t)
    for t in fk_recent:
        fk_best[t] = best_card_for_slot_from_hour(hour_data.get("four_kind", {}), t)
    if aa_pred:
        for t in aa_pred:
            aa_best.setdefault(t, best_card_for_slot_from_hour(hour_data.get("aa", {}), t))
    if fk_pred:
        for t in fk_pred:
            fk_best.setdefault(t, best_card_for_slot_from_hour(hour_data.get("four_kind", {}), t))

    # T√≠nh Top 5 ri√™ng cho AA v√† T·ª© qu√Ω
    top5_aa = compute_topN_for_box(hour_data, "aa", limit=5)
    top5_fk = compute_topN_for_box(hour_data, "four_kind", limit=5)

    return render_template("index.html",
        cards=cards, RANKS=RANKS, SUITS=SUITS,
        card_label=card_label, BOXES=BOXES,
        selected_card=sel, details=details,
        top_cards=top_cards, agg_percent=agg_percent,
        aa_recent=aa_recent, fk_recent=fk_recent,
        aa_pred=aa_pred, fk_pred=fk_pred,
        aa_best=aa_best, fk_best=fk_best,
        top5_aa=top5_aa, top5_fk=top5_fk,
        count_for_display=count_for_display
    )

@app.route("/save", methods=["POST"])
def save_round():
    first_card = request.form.get("first_card", "").strip()
    selected_boxes = request.form.getlist("selected_box")

    if not first_card or not selected_boxes:
        return redirect(url_for("index", card=first_card))

    data = load_data()
    hour_data = load_hour_data()
    now_str = format_hhmm(now_vn())  # slot HH:MM l∆∞u v√†o hour.json

    # T·∫°o round object (KH√îNG ch·ª©a timestamp)
    rec = {
        "round_id": str(uuid.uuid4()),
        "first_card": first_card,
        "selected_boxes": selected_boxes
    }
    data.append(rec)

    # C·∫≠p nh·∫≠t hour.json: hour gi·ªØ vai tr√≤ th·ªùi gian/slot
    slot = now_str
    if "aa" in selected_boxes:
        hour_data.setdefault("aa", {})
        hour_data["aa"].setdefault(slot, [])
        hour_data["aa"][slot].append(first_card)
    if "four_kind" in selected_boxes:
        hour_data.setdefault("four_kind", {})
        hour_data["four_kind"].setdefault(slot, [])
        hour_data["four_kind"][slot].append(first_card)

    save_data(data)
    save_hour_data(hour_data)
    return redirect(url_for("index"))

@app.route("/api/stats/<card>")
def api_stats_card(card: str):
    return jsonify(compute_stats_for_card(card))

@app.route("/api/boxes")
def api_boxes():
    return jsonify([
        {"key": k, "label": v[0], "payout": v[1], "color": v[2]}
        for k, v in BOXES.items()
    ])

@app.route("/admin/clear", methods=["POST"])
def admin_clear():
    save_data([])
    save_hour_data({"aa": {}, "four_kind": {}})
    return redirect(url_for("index"))

if __name__ == "__main__":
    ensure_data_file()
    ensure_hour_file()
    app.run(host="0.0.0.0", port=8080, debug=True)
=========================
# FILE: static/style.css
=========================
:root{
  --bg: #f6f8fb;
  --card: #ffffff;
  --border: #e3e6ea;
  --muted: #6f7780;
  --primary: #1a73e8;
  --orange: #d97a18;
  --red: #c92a2a;
  --shadow: rgba(15,23,42,0.08);
  --gap: 12px;
  --min-col: 120px;
}

/* -------------------------
   Reset / Base
   ------------------------- */
* { box-sizing: border-box; }
html, body { height: 100%; }
body{
  margin: 0;
  font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: #111;
  font-size: 14px;
  line-height: 1.35;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px;
  box-sizing: border-box;
  overflow-x: hidden;
}

/* -------------------------
   Utilities
   ------------------------- */
.hidden { display: none; }
.center { display:flex; align-items:center; justify-content:center; }
.muted { color: var(--muted); font-size:11px; }
.slot-percent { font-size:11px; color:var(--muted); margin-left:6px; font-weight:600; }

/* -------------------------
   Controls / Buttons
   ------------------------- */
.btn {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-weight:600;
}
.btn.primary { background:var(--primary); color:#fff; border-color:transparent; }

/* -------------------------
   Selector / Dropdown
   ------------------------- */
.grid-label { display:block; margin-bottom:6px; color:#333; font-weight:600; }
.card-grid { margin-bottom:10px; }
.card-row { display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin-bottom:4px; }
.card-btn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:3px 10px;
  border:1px solid var(--border);
  border-radius:6px;
  background:#fafafa;
  cursor:pointer;
  white-space:nowrap;
  text-align:center;
  transition: background .12s ease, border-color .12s ease;
  font-size:13px;
}
.card-btn:hover { background:#f0f8ff; }
.card-btn.selected { background:#d0ebff; border-color:var(--primary); color:var(--primary); }

.card-dropdown { position:relative; display:inline-block; margin-bottom:10px; }
.dropdown-toggle{
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:6px;
  background:#fff;
  cursor:pointer;
  min-width:160px;
  text-align:center;
  font-size:12px;
}
.dropdown-grid{
  display:none;
  position:absolute;
  top:100%;
  left:0;
  z-index:9999;
  background:#fff;
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  min-width:320px;
  max-height:60vh;
  overflow:auto;
}

/* -------------------------
   Layout: Top / Bottom
   ------------------------- */
/* Top block: three equal columns (uses fr to avoid percent+gap overflow) */
.top-block {
  display: grid;
  grid-template-columns: 33.3fr 33.3fr 33.3fr;
  gap: var(--gap);
  margin-bottom: var(--gap);
  align-items: stretch;
}
.top-block > * { min-width: 0; box-sizing: border-box; }

/* Bottom section: align widths with top (40/60 split) */
.bottom-section {
  display: grid;
  grid-template-columns: 40fr 60fr;
  gap: var(--gap);
  align-items: start;
  width: 100%;
  box-sizing: border-box;
}

/* Left / Right columns */
.left-block {
  width: 100%;
  min-width: 220px;
  display:flex;
  flex-direction:column;
  gap:5px;
  box-sizing: border-box;
}
.right-block {
  width: 100%;
  box-sizing: border-box;
  display: grid;
  grid-template-rows: auto auto auto;
  gap: 5px;
  align-items: start;
  min-width: calc(var(--min-col) * 2 + 24px);
}

/* -------------------------
   Box / Content
   ------------------------- */
/* Base box: fixed height, centered main content */
.box {
  position: relative;
  box-sizing: border-box;
  width: 100%;
  max-width: 100%;
  height: 120px;
  min-height: 120px;
  padding: 6px;
  background: #fff;
  border-radius: 8px;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  text-align: center;
  overflow: hidden;
}

/* Main content area (centered) */
.box .main {
  flex: 1 1 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
  box-sizing: border-box;
  min-width: 0;
}

/* Bottom area: pushed to box bottom and stacked payout above percent */
.box .bottom-area {
  margin-top: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
  justify-content: flex-end;
  padding: 6px 8px 8px;
  box-sizing: border-box;
  width: 100%;
}
/* --- Restore variant colors for draw (h√≤a), full_house (c√π l≈©) and four_kind (t·ª© qu√Ω) --- */

/* H√≤a / C√π l≈© (cam) */
.box.orange .label,
.box.orange .payout,
.box[data-val="draw"] .label,
.box[data-val="draw"] .payout,
.box[data-val="full_house"] .label,
.box[data-val="full_house"] .payout {
  color: var(--orange);
}

/* T·ª© qu√Ω (ƒë·ªè) */
.box.red .label,
.box.red .payout,
.box[data-val="four_kind"] .label,
.box[data-val="four_kind"] .payout {
  color: var(--red);
}

/* B·∫£o to√†n m√†u c·ªßa .percent (kh√¥ng ƒë·ªÉ b·ªã ghi ƒë√®) */
.box.orange .percent,
.box.red .percent,
.box[data-val="draw"] .percent,
.box[data-val="full_house"] .percent,
.box[data-val="four_kind"] .percent {
  color: #0a7d3a; /* gi·ªØ m√†u percent hi·ªán t·∫°i */
}

/* Nh·∫π nh√†ng nh·∫•n vi·ªÅn cho nh·∫≠n di·ªán (t√πy ch·ªçn, kh√¥ng b·∫Øt bu·ªôc) */
.box.orange { border-color: rgba(217,122,24,0.2); }
.box.red { border-color: rgba(201,42,42,0.2); }
/* If payout/percent are direct children of .box, support stacking and bottom alignment */
.box > .payout,
.box > .percent {
  display: block;
  width: 100%;
  text-align: center;
  margin: 0;
}

/* -------------------------
   Text / Inline elements
   ------------------------- */
.label { font-weight:600; font-size:11px; color:#3d3d3d; }
.payout {
  font-weight:500;
  font-size:9px;
  color:#555;
  margin: 0;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.percent {
  font-weight:600;
  font-size:9px;
  background:#ebffed;
  color:#0a7d3a;
  padding:3px 10px;
  border-radius:4px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:56px;
  margin: -4px;
}

/* -------------------------
   Right block rows / grids
   ------------------------- */
.rb-row {
  display: grid;
  grid-template-columns: repeat(2, minmax(var(--min-col), 1fr));
  gap: 10px;
  align-items: center;
  width: 100%;
  box-sizing: border-box;
}
.rb-row > * { min-width: 0; box-sizing: border-box; }
.rb-row .box {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  text-align: center;
}
.rb-row .box.full-width { grid-column: 1 / -1; }

/* AA & Four-kind grid */
.section .aa-fk-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(120px, 1fr));
  gap: 0px;
  align-items: start;
  width: 100%;
  box-sizing: border-box;
  margin-top: 6px;
}

/* Top5 grid */
.section .top5-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  align-items: start;
  width: 100%;
  box-sizing: border-box;
  margin-top: 6px;
}
.section .top5-column { padding: 6px; min-width: 0; box-sizing: border-box; }

.top5-box {
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #fff;
  padding: 10px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  box-sizing: border-box;
}
.top5-title { font-weight:700; margin-bottom:6px; color:#111; }
.top5-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 8px;
  border-bottom:1px dashed #eee;
}
.top5-item:last-child { border-bottom:0; }
.top5-left { display:flex; gap:8px; align-items:center; }
.top5-rank { font-weight:700; width:28px; color:#333; }
.top5-card { font-weight:700; color:#111; }
.top5-rate { color:var(--muted); font-weight:600; }

/* -------------------------
   Section / Misc
   ------------------------- */
.section{
  border:1px solid var(--border);
  border-radius:8px;
  background:#fafafa;
  padding:12px;
  margin-bottom:14px;
}
.section h3 { margin:0 0 8px; font-size:13px; font-weight:600; color:#333; text-align:center; }

/* Hover / selected */
.box:hover { background:#f7fbff; transform:translateY(-2px); transition: transform .12s ease, background .12s ease; }
.box.selected { background:#e8f4ff; border-color:#cfeaff; box-shadow:0 6px 14px rgba(26,115,232,0.06); }

/* Accessibility / focus */
.card-btn:focus, .dropdown-toggle:focus, .btn:focus {
  outline: 3px solid rgba(26,115,232,0.12);
  outline-offset: 2px;
}

/* -------------------------
   Responsive scaling (keep layout stable)
   ------------------------- */
@media (max-width: 1000px) {
  :root { --min-col: 100px; }
  body { font-size: 13px; }
  .box { height: 120px; min-height: 120px; padding: 10px; }
}
@media (max-width: 760px) {
  :root { --min-col: 88px; }
  body { font-size: 12px; }
  .box { height: 120px; min-height: 120px; padding: 8px; }
  .left-block { min-width: 180px; }
  .right-block { min-width: calc(var(--min-col) * 2 + 20px); }
}
@media (max-width: 520px) {
  :root { --min-col: 72px; }
  body { font-size: 11px; }
  .box { height: 110px; min-height: 110px; padding: 6px; }
  .left-block { min-width: 160px; }
  .right-block { min-width: calc(var(--min-col) * 2 + 16px); }
}

/* -------------------------
   Helpers
   ------------------------- */
.card-row { gap:8px; }
.dropdown-grid { box-shadow: 0 8px 24px rgba(0,0,0,0.08); max-height:60vh; overflow:auto; }
.label, .payout, .top5-card { word-break: break-word; overflow-wrap: anywhere; }
=========================
# FILE: templates/index.html
=========================
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Ph√¢n t√≠ch x√°c su·∫•t</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
<div class="container">

  <!-- CARD SELECTOR DROPDOWN-GRID -->
  <div class="card-dropdown">
    <div style="display:flex;align-items:center;gap:12px;">
      <div class="dropdown-toggle"
           id="dropdown-toggle"
           data-suit="{{ selected_card[1] if selected_card }}"
           onclick="toggleGrid()">
        {{ card_label(selected_card) if selected_card else "Ch·ªçn l√° b√†i ƒë·∫ßu ti√™n" }}
      </div>

      <!-- B·ªô ƒë·∫øm k·∫øt qu·∫£ -->
      <div style="font-size:9px;color:var(--muted);">
        X√°c su·∫•t ƒë∆∞·ª£c t√≠nh tr√™n d·ªØ li·ªáu <strong>{{ count_for_display }}</strong> tr·∫≠n
      </div>
    </div>

    <!-- form GET ƒë·ªÉ ch·ªçn l√° (submit khi ch·ªçn trong grid) -->
    <form id="card-select-form" method="GET" action="/" style="display:none;">
      <input type="hidden" name="card" id="card-input" value="{{ selected_card }}">
    </form>

    <div class="dropdown-grid" id="card-grid" aria-hidden="true">
      {% for r in RANKS %}
        <div class="card-row">
          {% for s in SUITS %}
            {% set c = r ~ s %}
            <div class="card-btn {% if selected_card == c %}selected{% endif %}"
                 data-suit="{{ s }}"
                 onclick="selectCard('{{ c }}')">
              {{ card_label(c) }}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- FORM L∆ØU -->
  <form method="POST" action="/save" id="save-form">
    <input type="hidden" name="first_card" id="save-first-card" value="{{ selected_card }}">
    <div id="selected-container"></div>

    <!-- TOP BLOCK -->
    <div class="section">
      <div class="top-block">
        {% for key in ["cowboy_win","draw","bull_win"] %}
        <div class="box top-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
          <div class="box-header">
            <div class="label">{{ BOXES[key][0] }}</div>
          </div>
          <div class="bottom-area">
            <div class="payout">{{ BOXES[key][1] }}</div>
            <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- BOTTOM SECTION -->
    <div class="bottom-section">

      <!-- LEFT -->
      <div class="section left-block">
        <h3>Player b·∫•t k·ª≥</h3>
        {% for key in ["suited_combo","pair_any","aa"] %}
        <div class="box left-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
          <div class="box-header">
            <div class="label">{{ BOXES[key][0] }}</div>
          </div>
          <div class="bottom-area">
            <div class="payout">{{ BOXES[key][1] }}</div>
            <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- RIGHT -->
      <div class="section right-block">
        <h3>B√†i c·ªßa ng∆∞·ªùi th·∫Øng</h3>
        <div class="rb-row">
          {% for key in ["high_onepair","two_pair"] %}
          <div class="box rb-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
            <div class="box-header">
              <div class="label">{{ BOXES[key][0] }}</div>
            </div>
            <div class="bottom-area">
              <div class="payout">{{ BOXES[key][1] }}</div>
              <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="rb-row">
          {% for key in ["trips","full_house"] %}
          <div class="box rb-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
            <div class="box-header">
              <div class="label">{{ BOXES[key][0] }}</div>
            </div>
            <div class="bottom-area">
              <div class="payout">{{ BOXES[key][1] }}</div>
              <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="rb-row">
          <div class="box rb-box full-width {{ BOXES['four_kind'][2] }}" data-val="four_kind" onclick="toggleSelect(this)">
            <div class="box-header">
              <div class="label">{{ BOXES['four_kind'][0] }}</div>
            </div>
            <div class="bottom-area">
              <div class="payout">{{ BOXES['four_kind'][1] }}</div>
              <div class="percent">
  {% set pct = (details.percent_by_section['four_kind'] if details and 'four_kind' in details.percent_by_section else agg_percent.get('four_kind', 0)) %}
  {{ pct|round(2) }}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
      </div>
    </div>
</div>
    <!-- N√∫t L∆∞u -->
    {% if selected_card %}
    <div class="save-form" style="margin-left:10px">
      <button type="submit" class="btn primary" onclick="syncSaveFirstCard()">L∆∞u</button>
      <button type="button" class="btn" onclick="clearSelection()">B·ªè ch·ªçn</button>
    </div>
    {% else %}
    <div class="muted" style="margin-left:10px;font-size:9px">Ch·ªçn l√° b√†i ƒë·∫ßu ti√™n v√† c√°c √¥ c∆∞·ª£c t∆∞∆°ng ·ª©ng ƒë·ªÉ ghi d·ªØ li·ªáu.</div>
    {% endif %}
  </form>
</div>

<!-- L·ªäCH S·ª¨ 3 M·ªêC G·∫¶N NH·∫§T V√Ä D·ª∞ ƒêO√ÅN 3 KHUNG GI·ªú K·∫æ TI·∫æP -->
<div class="section" style="margin-top:20px;">
  <h3 style="margin-bottom:12px;">‚è∞ Khung gi·ªù AA & T·ª© qu√Ω</h3>

  <div class="aa-fk-grid">
    <!-- AA column -->
    <div class="aa-column">
      <h4>üîπAA - 3 m·ªëc g·∫ßn nh·∫•t</h4>
      <ul>
        {% if aa_recent %}
          {% for t in aa_recent %}
            <li>
              {{ t }}
              {% set best = aa_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>

      <h4 style="margin-top:12px;">üîπAA - 3 m·ªëc s·∫Øp t·ªõi (d·ª± ƒëo√°n)</h4>
      <ul>
        {% if aa_pred %}
          {% for t in aa_pred %}
            <li>
              {{ t }}
              {% set best = aa_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>
    </div>

    <!-- Four-kind column -->
    <div class="fk-column">
      <h4>üî∏T·ª© - 3 m·ªëc g·∫ßn nh·∫•t</h4>
      <ul>
        {% if fk_recent %}
          {% for t in fk_recent %}
            <li>
              {{ t }}
              {% set best = fk_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>

      <h4 style="margin-top:12px;">üî∏T·ª© - 3 m·ªëc s·∫Øp t·ªõi (d·ª± ƒëo√°n)</h4>
      <ul>
        {% if fk_pred %}
          {% for t in fk_pred %}
            <li>
              {{ t }}
              {% set best = fk_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<!-- Top 5 ri√™ng AA & T·ª© (2 c·ªôt) -->
<div class="section" style="margin-top:12px;">
  <h3 style="margin-bottom:12px;">üèÜ Top 5 l√° b√†i c√≥ t·ªâ l·ªá n·ªï AA & T·ª© cao nh·∫•t</h3>

  <div class="top5-grid">
    <!-- AA Top5 -->
    <div class="top5-column">
      <div class="top5-box">
        <div class="top5-title">AA</div>
        {% if top5_aa %}
          {% for it in top5_aa %}
            <div class="top5-item">
              <div class="top5-left">
                <div class="top5-rank">{{ loop.index }}</div>
                <div class="top5-card">{{ card_label(it.card) }}</div>
              </div>
              <div class="top5-rate">{{ it.rate }}%</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:8px;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        {% endif %}
      </div>
    </div>

    <!-- Four-kind Top5 -->
    <div class="top5-column">
      <div class="top5-box">
        <div class="top5-title">T·ª© qu√Ω</div>
        {% if top5_fk %}
          {% for it in top5_fk %}
            <div class="top5-item">
              <div class="top5-left">
                <div class="top5-rank">{{ loop.index }}</div>
                <div class="top5-card">{{ card_label(it.card) }}</div>
              </div>
              <div class="top5-rate">{{ it.rate }}%</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:8px;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Four-kind minute chart -->
<div class="section" style="margin-top:20px;">
  <h3 style="margin-bottom:10px;">üìä Th·ªëng k√™ T·ª© qu√Ω theo khung gi·ªù (00:00 - 23:59)</h3>

  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
    <label style="font-size:13px;color:#333">G·ªôp m·ªói</label>
    <select id="fk-agg-select" style="padding:6px;border:1px solid #e3e6ea;border-radius:6px;">
      <option value="1">1 ph√∫t</option>
      <option value="5">5 ph√∫t</option>
      <option value="15">15 ph√∫t</option>
      <option value="60">60 ph√∫t</option>
    </select>
    <button id="fk-refresh-btn" class="btn" style="padding:6px 10px;margin-left:8px">C·∫≠p nh·∫≠t</button>
  </div>

  <div style="position:relative; width:100%; height:320px;">
    <canvas id="fourKindChart" aria-label="Bi·ªÉu ƒë·ªì ph√∫t n·ªï t·ª© qu√Ω"></canvas>
  </div>
</div>

<!-- include Chart.js and the new chart script (ƒë·∫∑t tr∆∞·ªõc </body>) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='four_kind_chart.js') }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sel = document.getElementById('fk-agg-select');
    const btn = document.getElementById('fk-refresh-btn');
    if (!sel || !btn) return;
    btn.addEventListener('click', function () {
      const agg = parseInt(sel.value, 10) || 1;
      if (window.refreshFourKindChart) window.refreshFourKindChart(agg);
    });
  });
      </script>
    
<script>
function toggleGrid(){
  var grid = document.getElementById('card-grid');
  var toggle = document.getElementById('dropdown-toggle');
  if(!grid) return;
  var open = grid.style.display === 'block';
  grid.style.display = open ? 'none' : 'block';
  grid.setAttribute('aria-hidden', open ? 'true':'false');
  if(toggle){ toggle.classList.toggle('open', !open); }
}

function selectCard(val){
  var input = document.getElementById('card-input');
  if(input){ input.value = val; }
  var grid = document.getElementById('card-grid');
  if(grid){ grid.style.display = 'none'; grid.setAttribute('aria-hidden','true'); }
  document.getElementById('card-select-form').submit();
}

function syncSaveFirstCard(){
  var sel = document.getElementById('card-input') ? document.getElementById('card-input').value : '';
  var saveInput = document.getElementById('save-first-card');
  if(saveInput) saveInput.value = sel;
}

function encodeId(key){ return 'sel-' + key.replace(/[^a-z0-9_\-]/gi, '_'); }

function toggleSelect(el){
  var val = el.getAttribute('data-val'); if(!val) return;
  var id = encodeId(val);
  var container = document.getElementById('selected-container');
  var existing = document.getElementById(id);

  var topKeys = ["cowboy_win","draw","bull_win"];
  if(topKeys.includes(val)){
    topKeys.forEach(function(k){
      if(k !== val){
        var otherId = encodeId(k);
        var otherEl = document.querySelector('.box[data-val="'+k+'"]');
        var otherInp = document.getElementById(otherId);
        if(otherInp){ otherInp.remove(); }
        if(otherEl){ otherEl.classList.remove('selected'); }
      }
    });
    if(existing){
      el.classList.remove('selected');
      existing.remove();
    } else {
      el.classList.add('selected');
      var inp=document.createElement('input');
      inp.type='hidden'; inp.name='selected_box'; inp.value=val; inp.id=id;
      container.appendChild(inp);
    }
    return;
  }

  if(existing){
    el.classList.remove('selected');
    existing.remove();
  } else {
    el.classList.add('selected');
    var inp=document.createElement('input');
    inp.type='hidden'; inp.name='selected_box'; inp.value=val; inp.id=id;
    container.appendChild(inp);
  }
}

function clearSelection(){
  document.querySelectorAll('.box.selected').forEach(function(b){ b.classList.remove('selected'); });
  var container = document.getElementById('selected-container');
  if(container){ container.innerHTML=''; }
}
</script>
  </body>
</html>
