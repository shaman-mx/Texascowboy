<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Ph√¢n t√≠ch x√°c su·∫•t</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
<div class="container">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
  <!-- CARD SELECTOR DROPDOWN-GRID -->
  <div class="card-dropdown">
    <div style="display:flex;align-items:center;gap:12px;">
      <div class="dropdown-toggle"
           id="dropdown-toggle"
           data-suit="{{ selected_card[1] if selected_card }}"
           onclick="toggleGrid()">
        {{ card_label(selected_card) if selected_card else "Ch·ªçn l√° b√†i ƒë·∫ßu ti√™n" }}
      </div>

      <!-- B·ªô ƒë·∫øm k·∫øt qu·∫£ -->
      <div style="font-size:9px;color:var(--muted);">
        X√°c su·∫•t ƒë∆∞·ª£c t√≠nh tr√™n d·ªØ li·ªáu <strong>{{ count_for_display }}</strong> tr·∫≠n
      </div>
    </div>

    <!-- form GET ƒë·ªÉ ch·ªçn l√° (submit khi ch·ªçn trong grid) -->
    <form id="card-select-form" method="GET" action="/" style="display:none;">
      <input type="hidden" name="card" id="card-input" value="{{ selected_card }}">
    </form>

    <div class="dropdown-grid" id="card-grid" aria-hidden="true">
      {% for r in RANKS %}
        <div class="card-row">
          {% for s in SUITS %}
            {% set c = r ~ s %}
            <div class="card-btn {% if selected_card == c %}selected{% endif %}"
                 data-suit="{{ s }}"
                 onclick="selectCard('{{ c }}')">
              {{ card_label(c) }}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- FORM L∆ØU -->
  <form method="POST" action="/save" id="save-form">
    <input type="hidden" name="first_card" id="save-first-card" value="{{ selected_card }}">
    <div id="selected-container"></div>

    <!-- TOP BLOCK -->
    <div class="section">
      <div class="top-block">
        {% for key in ["cowboy_win","draw","bull_win"] %}
        <div class="box top-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
          <div class="box-header">
            <div class="label">{{ BOXES[key][0] }}</div>
          </div>
          <div class="bottom-area">
            <div class="payout">{{ BOXES[key][1] }}</div>
            <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- BOTTOM SECTION -->
    <div class="bottom-section">

      <!-- LEFT -->
      <div class="section left-block">
        <h3>Player b·∫•t k·ª≥</h3>
        {% for key in ["suited_combo","pair_any","aa"] %}
        <div class="box left-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
          <div class="box-header">
            <div class="label">{{ BOXES[key][0] }}</div>
          </div>
          <div class="bottom-area">
            <div class="payout">{{ BOXES[key][1] }}</div>
            <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- RIGHT -->
      <div class="section right-block">
        <h3>B√†i c·ªßa ng∆∞·ªùi th·∫Øng</h3>
        <div class="rb-row">
          {% for key in ["high_onepair","two_pair"] %}
          <div class="box rb-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
            <div class="box-header">
              <div class="label">{{ BOXES[key][0] }}</div>
            </div>
            <div class="bottom-area">
              <div class="payout">{{ BOXES[key][1] }}</div>
              <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="rb-row">
          {% for key in ["trips","full_house"] %}
          <div class="box rb-box {{ BOXES[key][2] }}" data-val="{{ key }}" onclick="toggleSelect(this)">
            <div class="box-header">
              <div class="label">{{ BOXES[key][0] }}</div>
            </div>
            <div class="bottom-area">
              <div class="payout">{{ BOXES[key][1] }}</div>
              <div class="percent">
  {% set pct = (details.percent_by_section[key] if details else agg_percent[key]) %}
  {{ pct|round(2) }}%
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="rb-row">
          <div class="box rb-box full-width {{ BOXES['four_kind'][2] }}" data-val="four_kind" onclick="toggleSelect(this)">
            <div class="box-header">
              <div class="label">{{ BOXES['four_kind'][0] }}</div>
            </div>
            <div class="bottom-area">
              <div class="payout">{{ BOXES['four_kind'][1] }}</div>
              <div class="percent">
  {% set pct = (details.percent_by_section['four_kind'] if details and 'four_kind' in details.percent_by_section else agg_percent.get('four_kind', 0)) %}
  {{ pct|round(2) }}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
      </div>
    </div>
</div>
    <!-- N√∫t L∆∞u -->
    {% if selected_card %}
    <div class="save-form" style="margin-left:10px">
      <button type="submit" class="btn primary" onclick="syncSaveFirstCard()">L∆∞u</button>
      <button type="button" class="btn" onclick="clearSelection()">B·ªè ch·ªçn</button>
    </div>
    {% else %}
    <div class="muted" style="margin-left:10px;font-size:9px">Ch·ªçn l√° b√†i ƒë·∫ßu ti√™n v√† c√°c √¥ c∆∞·ª£c t∆∞∆°ng ·ª©ng ƒë·ªÉ ghi d·ªØ li·ªáu.</div>
    {% endif %}
  </form>
</div>

<!-- L·ªäCH S·ª¨ 3 M·ªêC G·∫¶N NH·∫§T V√Ä D·ª∞ ƒêO√ÅN 3 KHUNG GI·ªú K·∫æ TI·∫æP -->
<div class="section" style="margin-top:20px;">
  <h3 style="margin-bottom:12px;">‚è∞ Khung gi·ªù AA & T·ª© qu√Ω</h3>

  <div class="aa-fk-grid">
    <!-- AA column -->
    <div class="aa-column">
      <h4>üîπAA - 3 m·ªëc g·∫ßn nh·∫•t</h4>
      <ul>
        {% if aa_recent %}
          {% for t in aa_recent %}
            <li>
              {{ t }}
              {% set best = aa_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>

      <h4 style="margin-top:12px;">üîπAA - 3 m·ªëc s·∫Øp t·ªõi (d·ª± ƒëo√°n)</h4>
      <ul>
        {% if aa_pred %}
          {% for t in aa_pred %}
            <li>
              {{ t }}
              {% set best = aa_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>
    </div>

    <!-- Four-kind column -->
    <div class="fk-column">
      <h4>üî∏T·ª© - 3 m·ªëc g·∫ßn nh·∫•t</h4>
      <ul>
        {% if fk_recent %}
          {% for t in fk_recent %}
            <li>
              {{ t }}
              {% set best = fk_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>

      <h4 style="margin-top:12px;">üî∏T·ª© - 3 m·ªëc s·∫Øp t·ªõi (d·ª± ƒëo√°n)</h4>
      <ul>
        {% if fk_pred %}
          {% for t in fk_pred %}
            <li>
              {{ t }}
              {% set best = fk_best.get(t) %}
              {% if best %}
                ‚Äî <strong>{{ card_label(best.card) }}</strong>
                <span class="slot-percent">{{ best.rate }}%</span>
              {% else %}
                ‚Äî <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
          <li class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<!-- Top 5 ri√™ng AA & T·ª© (2 c·ªôt) -->
<div class="section" style="margin-top:12px;">
  <h3 style="margin-bottom:12px;">üèÜ Top 5 l√° b√†i c√≥ t·ªâ l·ªá n·ªï AA & T·ª© cao nh·∫•t</h3>

  <div class="top5-grid">
    <!-- AA Top5 -->
    <div class="top5-column">
      <div class="top5-box">
        <div class="top5-title">AA</div>
        {% if top5_aa %}
          {% for it in top5_aa %}
            <div class="top5-item">
              <div class="top5-left">
                <div class="top5-rank">{{ loop.index }}</div>
                <div class="top5-card">{{ card_label(it.card) }}</div>
              </div>
              <div class="top5-rate">{{ it.rate }}%</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:8px;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        {% endif %}
      </div>
    </div>

    <!-- Four-kind Top5 -->
    <div class="top5-column">
      <div class="top5-box">
        <div class="top5-title">T·ª© qu√Ω</div>
        {% if top5_fk %}
          {% for it in top5_fk %}
            <div class="top5-item">
              <div class="top5-left">
                <div class="top5-rank">{{ loop.index }}</div>
                <div class="top5-card">{{ card_label(it.card) }}</div>
              </div>
              <div class="top5-rate">{{ it.rate }}%</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:8px;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="charts-row">
  <!-- Four-kind -->
  <div class="chart-section">
    <h3 style="margin-bottom:12px;">üìä T·ª© qu√Ω theo khung gi·ªù</h3>
    <div class="controls" aria-label="Controls for four-kind chart">
      <label for="fk-agg-select">G·ªôp m·ªói</label>
      <select id="fk-agg-select" aria-controls="fourKindChart">
        <option value="1">1 ph√∫t</option>
        <option value="5">5 ph√∫t</option>
        <option value="15">15 ph√∫t</option>
        <option value="60">60 ph√∫t</option>
      </select>
    </div>
    <div class="chart-wrap">
      <canvas id="fourKindChart" aria-label="Bi·ªÉu ƒë·ªì ph√∫t n·ªï t·ª© qu√Ω"></canvas>
    </div>
  </div>

  <!-- AA -->
  <div class="chart-section">
    <h3 style="margin-bottom:12px;">üìä AA theo khung gi·ªù</h3>
    <div class="controls" aria-label="Controls for AA chart">
      <label for="aa-agg-select">G·ªôp m·ªói</label>
      <select id="aa-agg-select" aria-controls="aaChart">
        <option value="1">1 ph√∫t</option>
        <option value="5">5 ph√∫t</option>
        <option value="15">15 ph√∫t</option>
        <option value="60">60 ph√∫t</option>
      </select>
    </div>
    <div class="chart-wrap">
      <canvas id="aaChart" aria-label="Bi·ªÉu ƒë·ªì ph√∫t n·ªï AA"></canvas>
    </div>
  </div>
</div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='four_kind_chart.js') }}"></script>
<script src="{{ url_for('static', filename='aa_chart.js') }}"></script>
<script src="{{ url_for('static', filename='updatechart.js') }}"></script>
<script src="{{ url_for('static', filename='alert.js') }}"></script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script src="{{ url_for('static', filename='card.js') }}"></script>
  </body>
</html>